---
title: "Astroでアニメーションを実現してみた話"
layout: "../../layouts/BaseMarkdownLayout.astro"
date: "2025-04-28"
description: "Astroでアニメーションを実現する方法を考察し、実際に実装してみた。"
author: "Mekann"
tags: ["Astro", "anime.js", "アニメーション", "CSS", "JavaScript"]
---

## はじめに  
Astro の “島（Island）アーキテクチャ” は、**ページ全体は静的 HTML／対話的な部分だけをクライアント側で動かす** という思想です。今回はその利点を活かしつつ、**anime.js** を使って SVG ベースの波アニメーションを実装した経緯と、実装上の勘所をまとめました。コードの掲載は避け、設計指針とチューニングポイントのみに絞って解説します。
<li><a href="/anime"  class="nav-link">Anime</a></li>
<li><a href="/test"  class="nav-link">Anime2</a></li>

---

## なぜ anime.js を選んだのか  

| 観点 | 選定理由 |
|------|----------|
| **依存がゼロに近い** | CDN から ESM をそのまま読み込め、バンドラ設定を変更せず導入できる。 |
| **ファイルサイズが小さい** | minified 版で約 17 KB。Three.js と比べ初期ロード負荷が抑えられる。 |
| **タイムライン API が直感的** | SVG や CSS プロパティを declarative に連鎖させ、細かなイージングも定義しやすい。 |

---

## 目指したアニメーション像  

- **連続する複数の波線がゆらぎながら横方向に流れる**  
- **モバイルを含む全デバイスで 60 FPS を維持**  

波動関数の数式を JS で直描きする手もありますが、今回は「SVG パスを事前生成 → anime.js で属性（`d` や `stroke-dashoffset`）をアニメーション」というアプローチを採用しました。  

---

## Island コンポーネントの設計  

1. **波アニメーションを独立した Astro コンポーネントに分離**  
   - `client:load` を宣言し、ページ読み込み後にのみ anime.js が実行されるようにする。  
2. **SVG 要素を CSS で `position: absolute; inset: 0;`**  
   - レイアウトシフトを防ぎ、常にビューポート全体を覆う。  
3. **Prop でカラーテーマや速度を外部から制御**  
   - ダーク／ライト・テーマ切替に追従しやすく、再利用性が高い。  

---

## パフォーマンス・アクセシビリティ対策  

| 手法 | 効果 |
|------|------|
| **`prefers-reduced-motion` を監視** | OS でアニメーション無効を選択している場合は再生を停止し、静止状態で描画。 |
| **`will-change: transform` の限定使用** | アニメ対象を限定し、レンダラが無駄にレイヤーを生成しないようにする。 |
| **FPS モニタリング** | DevTools の Performance パネルで 50 FPS 未満のフレームを洗い出し、タイムライン長を調整。 |
| **インライン SVG + gzip 効率化** | 外部ファイルよりも 1 RTT 減らし、gzip 圧縮で数百バイトまで削減。 |

---

## 開発中につまずいた点と解決策  

| 症状 | 原因 | 解決策 |
|------|------|--------|
| **スクロール時に波がカクつく** | メインスレッドの負荷増大 | アニメーションループを CSS プロパティのみにし、レイアウト再計算をゼロにした。 |
| **Safari で stroke が途切れる** | `stroke-linecap: round` の相性 | `butt` に変更し、波の角を意識的に鈍らせて視覚差を解消。 |
| **モバイル横向きで縦横比が崩れる** | `viewBox` 設定漏れ | SVG を `preserveAspectRatio="xMidYMid slice"` で固定した。 |

---

## 実装後の効果測定  

- **Largest Contentful Paint (LCP)**: 1.3 s → 1.1 s  
- **First Input Delay (FID)**: 12 ms → 8 ms  
- **累積レイアウトシフト (CLS)**: 0.02 以下を維持  

特に LCP の改善幅が大きく、これは **初期バンドルから Three.js を外しただけで 100 KB 以上削減できた** ことが主因でした。  

---

## まとめ  

Astro の “静的優先” という思想と anime.js の “軽量・宣言的” な API は相性が良く、**無理に heavy な WebGL を持ち込まなくても視覚表現の幅は広がる** という手応えを得ました。  

アニメーション実装で迷った際は、  

1. **まず表現したい動きが CSS / SVG だけで賄えないか考える**  
2. **必要最小限のランタイムを選び、Island に閉じ込める**  
3. **パフォーマンス計測を早い段階でループに組み込む**  

という三段階で判断すると、後戻りコストを最小化できます。  

次は **ScrollTrigger + anime.js** でセクションごとに連動する演出を試す予定です。実装が安定したら、また別の記事で掘り下げてみます。

