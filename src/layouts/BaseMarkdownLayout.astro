---
import '../styles/global.pcss';
/// <reference types="astro/client" />
import type { MarkdownHeading } from 'astro';

// --- Props処理 ---
// Markdownレイアウトとして使用する場合、Astroが自動的にheadingsをpropsに含めてくれる
const { headings } = Astro.props as { headings: MarkdownHeading[] };
const rawProps = (Astro.props as any).frontmatter ?? Astro.props;
const {
  title,
  description,
  author,
  tags,
  date,
  pubDate,
  ogImage,
} = rawProps as {
  title: string;
  description?: string;
  author?: string;
  tags?: string[];
  date?: string | Date;
  pubDate?: string;
  ogImage?: string;
};

// --- OGP/URL関連 (変更なし) ---
const canonicalURL = Astro.url;
const siteName = 'Mekann';
const imagePath = ogImage || '/default-og-image.png';
const absoluteImageUrl = new URL(imagePath, Astro.url.origin).href;

// --- 日付処理 (変更なし) ---
let sourceDate: string | Date | undefined = date ?? pubDate;
let parsedDate: Date | null = null;
let isoDate = '';
if (typeof sourceDate === 'string') {
  try {
    parsedDate = new Date(sourceDate);
    if (isNaN(parsedDate.valueOf())) {
      parsedDate = null;
    } else {
      isoDate = parsedDate.toISOString();
    }
  } catch (e) {
    parsedDate = null;
  }
} else if (sourceDate instanceof Date) {
  if (!isNaN(sourceDate.valueOf())) {
    parsedDate = sourceDate;
    isoDate = parsedDate.toISOString();
  } else {
    parsedDate = null;
  }
}
const validDate = parsedDate instanceof Date;
const displayDate = validDate
  ? parsedDate!.toLocaleDateString('ja-JP', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
    })
  : '';
---

<html lang="ja" class="bg-black">
  <head>
    {/* Head内は変更なし */}
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <base href="/" />
    {description && <meta name="description" content={description} />}
    <meta property="og:title" content={title} />
    {description && <meta property="og:description" content={description} />}
    <meta property="og:url" content={canonicalURL.href} />
    <meta property="og:site_name" content={siteName} />
    <meta property="og:image" content={absoluteImageUrl} />
    <meta property="og:type" content="article" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    {description && <meta name="twitter:description" content={description} />}
    <meta name="twitter:image" content={absoluteImageUrl} />
  </head>

  <body class="bg-black text-white text-base bg-faint-image">
    {/* --- Header (変更なし) --- */}
    <header class="fixed inset-x-0 top-0 z-50 bg-black border-b border-gray-800 shadow-lg text-base">
      <nav class="container mx-auto flex items-center justify-between py-4 px-6 lg:px-8">
        <a href="/" class="text-white font-semibold text-base hover:text-blue-300 transition-colors">{siteName}</a>
        <ul class="flex gap-6 text-sm">
          <li><a href="/" class="text-gray-400 hover:text-white no-underline">Home</a></li>
          <li><a href="/blog" class="text-gray-400 hover:text-white no-underline">Blog</a></li>
        </ul>
      </nav>
    </header>

    {/* --- Main Content (3カラムレイアウトに変更) --- */}
    <main class="container mx-auto px-6 lg:px-8 pt-28 pb-12">
      <div class="grid grid-cols-1 lg:grid-cols-12 lg:gap-x-8">
        
        {headings && headings.length > 1 && (
          <aside class="hidden lg:block lg:col-span-3">
            <div class="sticky top-28">
              <a href="/blog/" class="inline-flex items-center text-gray-500 hover:text-white mb-6 lg:mb-8 no-underline text-base">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Back to Blog
              </a>
              <h2 class="text-sm font-bold tracking-wider uppercase text-gray-500 mb-4">On this page</h2>
              <nav>
                <ul class="space-y-2">
                  {headings.filter(h => h.depth > 1 && h.depth < 4).map((heading) => (
                    <li>
                      <a 
                        href={`${Astro.url.pathname}#${heading.slug}`}
                        class="text-gray-400 hover:text-white transition-colors text-sm block"
                        style={`padding-left: ${(heading.depth - 2) * 1}rem;`}
                      >
                        {heading.text}
                      </a>
                    </li>
                  ))}
                </ul>
              </nav>
            </div>
          </aside>
        )}

        <div class="lg:col-span-6">
          <article
            class="prose prose-sm prose-invert mx-auto max-w-4xl
                   leading-snug font-jp-sans
                   bg-black/0
                   prose-pre:bg-slate-800 prose-pre:text-gray-100 prose-pre:p-4 
                   prose-pre:rounded-lg prose-pre:overflow-auto prose-pre:my-6
                   prose-code:bg-transparent prose-code:text-inherit"
          >
            {validDate && (
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between text-sm text-gray-500 mb-6 lg:mb-8">
                <time datetime={isoDate}>{displayDate}</time>
                {author && <span class="mt-1 sm:mt-0 sm:ml-4">By {author}</span>}
              </div>
            )}

            <h1 class="text-2xl font-bold text-white mb-8 lg:mb-10">{title}</h1>
            
            {/* 本文のコンテンツがここに表示される */}
            <slot />
          </article>
        </div>
        
        {tags && tags.length > 0 && (
          <aside class="lg:col-span-3 mt-16 lg:mt-0">
            <div class="sticky top-28">
              <h2 class="text-sm font-bold tracking-wider uppercase text-gray-500 mb-4">Tags</h2>
              <div class="flex flex-wrap gap-3">
                {tags.map((tag) => (
                  <a
                    href={`/tags/${tag}`}
                    class="bg-gray-800 text-blue-300 hover:bg-gray-700 hover:text-blue-200 px-3 py-1 rounded-full text-sm no-underline transition-colors"
                  >
                    #{tag}
                  </a>
                ))}
              </div>
            </div>
          </aside>
        )}

      </div>
    </main>

    {/* --- Footer (変更なし) --- */}
    <footer class="bg-black text-gray-400 border-t border-gray-800 py-6 lg:py-8 text-base">
      <div class="container mx-auto text-center text-sm px-6 lg:px-8">
        © {new Date().getFullYear()} {siteName}
      </div>
    </footer>
  </body>
</html>